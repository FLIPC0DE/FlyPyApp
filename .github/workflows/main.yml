name: PyFly CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: "18.x"

jobs:
  setup:
    name: üîß Setup Proyecto
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Mostrar contexto
        run: |
          echo "üöÄ CI/CD para PyFly"
          echo "üìÖ Fecha: $(date)"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üë§ Usuario: ${{ github.actor }}"
          echo "üí¨ Commit: ${{ github.event.head_commit.message }}"

  estructura:
    name: üìÇ Verificar estructura
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Listar archivos
        run: ls -la

      - name: Verificar carpetas principales
        run: |
          echo "üîç Verificando carpetas..."
          [ -d "BACKEND" ] && echo "‚úÖ BACKEND presente" || echo "‚ö†Ô∏è BACKEND faltante"
          [ -d "FRONTEND" ] && echo "‚úÖ FRONTEND presente" || echo "‚ö†Ô∏è FRONTEND faltante"

  backend:
    name: üß™ Test Backend
    runs-on: ubuntu-latest
    needs: estructura

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: BACKEND/package-lock.json

      - name: Instalar dependencias
        working-directory: ./BACKEND
        run: npm ci

      - name: Crear archivo .env temporal
        working-directory: ./BACKEND
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "SMTP_USER=${{ secrets.SMTP_USER }}" >> .env
          echo "SMTP_PASS=${{ secrets.SMTP_PASS }}" >> .env
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
          echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env
          echo "MICROSOFT_CLIENT_ID=${{ secrets.MICROSOFT_CLIENT_ID }}" >> .env
          echo "MICROSOFT_CLIENT_SECRET=${{ secrets.MICROSOFT_CLIENT_SECRET }}" >> .env
          echo "CLIENT_ID_GITHUB=${{ secrets.CLIENT_ID_GITHUB }}" >> .env
          echo "CLIENT_SECRET_GITHUB=${{ secrets.CLIENT_SECRET_GITHUB }}" >> .env

      - name: Verificar DATABASE_URL
        working-directory: ./BACKEND
        run: grep DATABASE_URL .env

      - name: Generar Prisma Client
        working-directory: ./BACKEND
        run: npx prisma generate

      - name: Aplicar migraciones
        working-directory: ./BACKEND
        run: npx prisma migrate deploy

      - name: Poblar base de datos (seed)
        working-directory: ./BACKEND
        run: npm run prisma:seed

      - name: Ejecutar lint
        working-directory: ./BACKEND
        run: npm run lint || echo "‚ö†Ô∏è Lint no configurado"

      - name: Ejecutar tests con cobertura
        working-directory: ./BACKEND
        run: npm run test:coverage

      - name: Guardar reporte de cobertura
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: BACKEND/coverage

  frontend:
    name: üé® Lint Frontend
    runs-on: ubuntu-latest
    needs: estructura

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: FRONTEND/package-lock.json

      - name: Instalar dependencias
        working-directory: ./FRONTEND
        run: npm ci

      - name: Ejecutar lint
        working-directory: ./FRONTEND
        run: npm run lint || echo "‚ö†Ô∏è Lint no configurado"

  resumen:
    name: üìä Resumen CI/CD
    runs-on: ubuntu-latest
    needs: [setup, estructura, backend, frontend]
    if: always()

    steps:
      - name: Mostrar resumen
        run: |
          echo "================================"
          echo "   RESUMEN DE EJECUCI√ìN"
          echo "================================"
          echo "‚úÖ Setup: ${{ needs.setup.result }}"
          echo "‚úÖ Estructura: ${{ needs.estructura.result }}"
          echo "‚úÖ Backend: ${{ needs.backend.result }}"
          echo "‚úÖ Frontend: ${{ needs.frontend.result }}"
          echo "================================"
          echo "üéâ ¬°PyFly CI/CD funcionando!"
